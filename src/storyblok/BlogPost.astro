---
import {
  storyblokEditable,
  renderRichText,
  useStoryblokApi,
} from "@storyblok/astro"
import IlStory from "../components/cms/IlStory.astro"
import SvgSingleBranch from "../components/svg/SvgSingleBranch.astro"
import SectionHeader from "../components/SectionHeader.astro"
import IconBase from "../components/svg/IconBase"
import IconArrow from "../components/svg/IconArrow"
import LayoutSpacer from "../components/LayoutSpacer.astro"
import IlTestimonial from "../components/IlTestimonial.astro"
import BlogStories from "../components/BlogStories.astro"
import ButtonEffect from "../components/ButtonEffect.astro"
import Contact from "../sections/home/Contact.astro"

type Props = {
  id: string
  blok: any
}

const { id, blok } = Astro.props

const { teaser, chapters, slides, title, image, testimonial } = blok

const storyblokApi = useStoryblokApi()
const newestStories = await Promise.all(
  (
    await storyblokApi.getStories({
      version: import.meta.env.DEV ? "draft" : "published",
      sort_by: "content.createdAt:desc",
      per_page: 2,
      excluding_ids: id,
    })
  ).data.stories,
)
console.log({ newestStories })
---

<section class="text-bluegray" {...storyblokEditable(blok)}>
  <IlStory
    slides={slides.map((slide: any) => slide.filename)}
    chapters={chapters}
  >
    <div
      slot="image"
      class="relative w-[95%] lg:w-1/2 self-start lg:self-center flex-initial"
    >
      <img
        class="w-7/8 border-8 border-solid border-white drop-shadow"
        src={image.filename}
      />
      <SvgSingleBranch
        class="w-1/4 text-emerald fill-current absolute right-0 bottom-0 -translate-x-1 translate-y-4"
      />
    </div>

    <SectionHeader slot="title">
      <span slot="roofline">Stories</span>
      {title}
    </SectionHeader>

    <div
      class="flex flex-col gap-4 items-center lg:items-start text-center lg:text-left max-w-prose"
      slot="content"
    >
      <Fragment set:html={renderRichText(teaser)} />
    </div>
  </IlStory>

  {testimonial.length && <IlTestimonial testimonial={testimonial[0]} />}

  <IconBase className="text-sunset w-full h-16 mt-8">
    <IconArrow />
  </IconBase>

  <LayoutSpacer />

  <BlogStories stories={newestStories}>
    <div slot="tail">
      <LayoutSpacer />

      <a href="/stories">
        <ButtonEffect class="text-sunset w-[fit-content] mx-auto">
          Hier gibt's alle Beitr√§ge
        </ButtonEffect>
      </a>

      <LayoutSpacer ms={4} />

      <IconBase
        className="text-sunset w-full h-16 mt-8 absolute bottom-0 -mb-10"
      >
        <IconArrow />
      </IconBase>
    </div>
  </BlogStories>

  <Contact class="mt-20" />
</section>
